# 通过注入动态库实现极速编译调试



### 1.概述


> iOS 原生代码的编译调试，都是通过一遍又一遍地编译重启 App 来进行的。所以，项目代码量越大，编译时间就越长。虽然我们可以通过将部分代码先编译成二进制集成到工程里，来避免每次都全量编译来加快编译速度，但即使这样，每次编译都还是需要重启 App，需要再走一遍调试流程

> 那么问题来了，原生代码怎样才能够实现动态极速调试，以此来大幅提高编译调试速度呢？


### 2.Injection for Xcode

> John Holdsworth 开发了一个叫作 Injection 的工具可以动态地将 Swift 或 Objective-C 的代码在已运行的程序中执行，以加快调试速度，同时保证程序不用重启


* 开源地址：https://github.com/johnno1962/InjectionIII


#### 2.1 原理

* Injection 会监听源代码文件的变化，如果文件被改动了，Injection Server 就会执行 rebuildClass 重新进行编译、打包成动态库，也就是 .dylib 文件。编译、打包成动态库后使用 writeString 方法通过 Socket 通知运行的 App

#### 2.2 替换流程

* Server 会在后台发送和监听 Socket 消息，实现逻辑在 InjectionServer.mm 的 runInBackground 方法里。Client 也会开启一个后台去发送和监听 Socket 消息，实现逻辑在 InjectionClient.mm里的 runInBackground 方法里
* Client 接收到消息后会调用 inject(tmpfile: String) 方法，运行时进行类的动态替换（大部分都是做新类动态替换旧类）

#### 2.3 动态库如何加载可执行文件？

* inject(tmpfile: String) 的入参 tmpfile 是动态库的文件路径，具体的实现在 inject(tmpfile: String) 方法开始里
* dlopen 会把 tmpfile 动态库文件载入运行的 App 里，返回指针 dl。接下来，dlsym 会得到 tmpfile 动态库的符号地址，然后就可以处理类的替换工作了



