# 包瘦身

### 1. App Thinning

> 会专门针对不同的设备来选择只适用于当前设备的内容以供下载

#### 1.1 三种方式，包括：App Slicing、Bitcode、On-Demand Resources

* App Slicing：向 iTunes Connect 上传 App 后，对 App 做切割，创建不同的变体，这样就可以适用到不同的设备
* On-Demand Resources：为游戏多关卡场景服务的。它会根据用户的关卡进度下载随后几个关卡的资源，并且已经过关的资源也会被删掉，这样就可以减少初装 App 的包大小
* Bitcode：针对特定设备进行包大小优化，优化不明显


### 2.图片资源

#### 2.1 删除无用图片
  
#### 2.1.1 6 大步
 
* 1. 通过 find 命令获取 App 安装包中的所有资源文件，比如 find /Users/daiming/Project/ -name
* 2. 设置用到的资源的类型，比如 jpg、gif、png、webp
* 3. 使用正则匹配在源码中找出使用到的资源名，比如 pattern = @"@"(.+?)""
* 4. 使用 find 命令找到的所有资源文件，再去掉代码中使用到的资源文件，剩下的就是无用资源了
* 5. 对于按照规则设置的资源名，我们需要在匹配使用资源的正则表达式里添加相应的规则，比如 @“image_%d”。确认无用资源后，就可以对这些无用资源执行删除操作了
* 6. 这个删除操作，你可以使用 NSFileManger 系统类提供的功能来完成

#### 2.1.2 工具

* [LSUnusedResources](https://github.com/tinymind/LSUnusedResources)

#### 2.2 图片压缩

#### 2.2.1 普通压缩

* 网页工具 [TinyPng](https://tinypng.com)
* GUI 工具 [ImageOptim](https://imageoptim.com/mac) 

#### 2.2.2 使用 [WebP](https://developers.google.com/speed/webp/)

> 压缩率高，而且肉眼看不出差异，同时支持有损和无损两种压缩模式。比如，将 Gif 图转为 Animated WebP ，有损压缩减少 64%，无损压缩减少 19%
> 支持 Alpha 透明和 24-bit 颜色数，不会像 PNG8 那样因为色彩不够而出现毛边

  * 谷歌 [cwebp](https://developers.google.com/speed/webp/docs/precompiled)：将其他图片转成 WebP
  * 腾讯 [iSparta](http://isparta.github.io)：是一个 GUI 工具，操作方便快捷，支持 PNG 格式转 WebP（其它类型图片需转为 PNG）
  * 显示图片时使用 libwebp 进行解析【[iOS 工程使用 libwebp 的范例](https://github.com/carsonmcdonald/WebP-iOS-example)】
  * WebP 在 CPU 消耗和解码时间上会比 PNG 高两倍
  * 建议大小超过了 100KB，可使用 WebP；而小于 100KB 时，可使用 TinyPng 或者 ImageOptim 进行压缩

### 3. 代码瘦身

> 找到并删除无用代码

* 1. 找出方法和类的全集
* 2. 找到使用过的方法和类
* 3. 取二者的差集得到无用代码
* 4. 由人工确认无用代码可删除后，进行删除即可


#### 3.1 找出方法和类的全集

#### 3.1.1 LinkMap

> 获取 LinkMap 可以通过将 Build Setting 里的 Write Link Map File 设置为 Yes，指定 Path to Link Map File 的路径就可以得到每次编译后的 LinkMap
> 通过 LinkMap ，你不光可以统计出所有的方法和类，还能够清晰地看到代码所占包大小的具体分布，进而有针对性地进行代码优化

#### 3.1.2 LinkMap 文件分为三部分：Object File、Section 和 Symbols

* Object File 包含了代码工程的所有文件
* Section 描述了代码段在生成的 Mach-O 里的偏移位置和大小
* Symbols 会列出每个方法、类、block，以及它们的大小


#### 3.2 找到使用过的方法和类

> objc_msgSend 在 Mach-O 文件里是通过 __objc_selrefs 这个 section 来获取 selector 这个参数的
> __objc_selrefs 里的方法一定是被调用了的。__objc_classrefs 里是被调用过的类，__objc_superrefs 是调用过 super 的类。通过 __objc_classrefs 和 __objc_superrefs，我们就可以找出使用过的类和子类

#### 3.2.1 工具 AppCode




